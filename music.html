<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç„¡æƒ³ã®MusicPlayer </title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');

:root {
  --main-bg: #0a0a0a;
  --text-color: #00ff41;
  --highlight-color: #f0f0f0;
  --lyrics-color: #00ccff;
}

* { box-sizing: border-box; }
body, html {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  background-color: var(--main-bg);
  color: var(--text-color);
  font-family: 'Share Tech Mono', monospace;
  overflow: hidden;
  text-shadow: 0 0 5px var(--text-color), 0 0 10px var(--text-color);
}

#container {
  width: 100%; height: 100%;
  padding: 2vw;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

/* CRTæ‰«æçº¿æ•ˆæœ */
#container::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,0.25) 50%),
              linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06));
  background-size: 100% 3px, 4px 100%;
  animation: scanline 8s linear infinite;
  pointer-events: none;
  z-index: 2;
}
@keyframes scanline { from {background-position:0 0;} to {background-position:0 100%;} }

#visuals {
  flex: 1;
  overflow-y: auto;
  font-size: 1rem;
  padding-bottom: 10px;
}
#lyrics-container {
  border-top: 1px solid var(--text-color);
  height: 40%;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 10px;
}
.lyrics-line {
  font-family: 'VT323', monospace;
  font-size: 1.6em;
  color: var(--lyrics-color);
  margin: 5px 0;
  opacity: 0.5;
  transition: 0.3s;
}
.lyrics-line.active {
  opacity: 1;
  transform: scale(1.1);
  color: var(--highlight-color);
  text-shadow: 0 0 8px var(--highlight-color);
}
#controls {
  position: fixed;
  bottom: 20px; right: 20px;
  z-index: 10;
  display: flex; flex-direction: column; gap: 10px;
}
.control-btn {
  background: rgba(0,0,0,0.7);
  border: 1px solid var(--text-color);
  color: var(--text-color);
  padding: 8px 12px;
  cursor: pointer;
}
.control-btn:hover {
  background: rgba(0,255,65,0.2);
}
#file-info {
  position: fixed;
  top: 10px; left: 20px;
  color: var(--text-color);
}
</style>
</head>
<body>
<div id="container">
  <div id="file-info">ğŸµ ç„¡æƒ³ã®MusicPlayer (GitHub Pages ç‰ˆ)</div>
  <div id="visuals"></div>
  <div id="lyrics-container"><div class="lyrics-line">åŠ è½½ä¸­...</div></div>
</div>

<div id="controls"></div>

<audio id="song" controls style="position:fixed;bottom:10px;left:10px;width:90%;"></audio>

<script>
const GITHUB_USER = "GGGinnnnn";  
const REPO_NAME   = "music";        
const BRANCH      = "main";               

const controls = document.getElementById('controls');
const visuals = document.getElementById('visuals');
const lyricsContainer = document.getElementById('lyrics-container');
const song = document.getElementById('song');
const fileInfo = document.getElementById('file-info');
let lyricsData = [], currentLyricIndex = -1;
let animationFrameId;

// åŠ è½½æ­Œæ›²åˆ—è¡¨
async function loadSongList() {
  try {
    const apiURL = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/songs?ref=${BRANCH}`;
    const res = await fetch(apiURL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    controls.innerHTML = "";
    if (Array.isArray(data)) {
      data.filter(f => f.name.match(/\.(mp3|wav)$/i)).forEach(f => {
        const btn = document.createElement('button');
        btn.textContent = f.name.replace(/\.[^/.]+$/, "");
        btn.className = 'control-btn';
        btn.onclick = () => loadSong(f.download_url, f.name);
        controls.appendChild(btn);
      });
      if (controls.innerHTML === "") controls.innerHTML = "<div>æœªæ‰¾åˆ°æ­Œæ›²æ–‡ä»¶</div>";
    }
  } catch (err) {
    controls.innerHTML = `<div>âš ï¸ åŠ è½½å¤±è´¥: ${err.message}</div>`;
  }
}

async function loadSong(url, name) {
  cancelAnimationFrame(animationFrameId);
  currentLyricIndex = -1;
  lyricsContainer.innerHTML = "<div class='lyrics-line'>æ­Œè¯åŠ è½½ä¸­...</div>";
  visuals.innerHTML = "";

  fileInfo.textContent = `ğŸ¶ å½“å‰æ­Œæ›²: ${name}`;
  song.src = url;
  song.play();

  // è‡ªåŠ¨åŠ è½½æ­Œè¯
  const lyricName = name.replace(/\.[^/.]+$/, ".lrc");
  const lyricURL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/${BRANCH}/lyrics/${lyricName}`;
  try {
    const res = await fetch(lyricURL);
    if (!res.ok) throw new Error("æœªæ‰¾åˆ°æ­Œè¯");
    const text = await res.text();
    parseLyrics(text);
    displayLyrics();
  } catch (e) {
    lyricsContainer.innerHTML = `<div class='lyrics-line'>âŒ ${e.message}</div>`;
  }
}

// è§£æLRCæ­Œè¯
function parseLyrics(content) {
  lyricsData = [];
  const lines = content.split('\n');
  const timeRegex = /\[(\d+):(\d+)(?:[.:](\d+))?\]/;
  for (const line of lines) {
    const match = line.match(timeRegex);
    if (match) {
      const min = parseInt(match[1]);
      const sec = parseInt(match[2]);
      const ms  = parseInt(match[3] || "0");
      const time = min * 60 + sec + ms / 100;
      const text = line.replace(timeRegex, '').trim();
      if (text) lyricsData.push({ time, text });
    }
  }
  lyricsData.sort((a,b)=>a.time-b.time);
}

// æ˜¾ç¤ºæ­Œè¯
function displayLyrics() {
  lyricsContainer.innerHTML = "";
  lyricsData.forEach((lyric,i)=>{
    const div = document.createElement('div');
    div.className = 'lyrics-line';
    div.id = `lyric-${i}`;
    div.textContent = lyric.text;
    lyricsContainer.appendChild(div);
  });
}

// æ›´æ–°æ—¶é—´é©±åŠ¨æ­Œè¯æ»šåŠ¨
song.addEventListener('timeupdate', ()=>{
  if (!lyricsData.length) return;
  const t = song.currentTime;
  let idx = lyricsData.findIndex((l,i)=> t < l.time && i>0) - 1;
  if (idx < 0) idx = lyricsData.length - 1;
  if (idx !== currentLyricIndex) {
    document.querySelectorAll('.lyrics-line').forEach(l=>l.classList.remove('active'));
    const active = document.getElementById(`lyric-${idx}`);
    if (active) {
      active.classList.add('active');
      active.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    currentLyricIndex = idx;
  }
});

// åˆå§‹åŠ è½½
loadSongList();
</script>
</body>
</html>
